=== Bonzai Payment Gateway ===
Contributors: bonzai
Tags: payment, checkout, bonzai, woocommerce, gateway, digital-products, subscriptions, webhook
Requires at least: 5.0
Tested up to: 6.9
Requires PHP: 7.4
Stable tag: 1.5.0
License: GPLv2 or later
License URI: https://www.gnu.org/licenses/gpl-2.0.html

A complete WooCommerce payment gateway for Bonzai Checkout with subscriptions, VAT handling, webhook automation, and automatic order synchronization.

== Description ==

Bonzai Payment Gateway allows WooCommerce stores to accept payments through **Bonzai Premium Checkout** ‚Äî supporting card and crypto payments, recurring subscriptions, and instant access delivery.

Designed for digital product creators, course sellers, educators, and membership site owners.

**Main features:**

* Global Bonzai Product UUID
* Per-product VAT handling (incl./excl.)
* Per-product payment mode (one-off, monthly subscription, yearly subscription)
* Auto-detect WooCommerce Subscription products
* Dynamic checkout title (product name or bundle)
* Automatic redirect to Bonzai Checkout
* Generate Webhook Token with one click
* Real-time webhook validation (granted / revoked)
* Full Retrieve-an-Order integration:
  - Manual order verification (admin UI)
  - Automatic cron sync (daily or weekly)
* Auto-update WooCommerce order status
* Debug mode and detailed logs
* Compatible with all WooCommerce themes, builders, and LMS platforms

This plugin requires an active **Bonzai Premium** subscription.

== Installation ==

1. Upload the plugin files to `/wp-content/plugins/bonzai-gateway/`
2. Activate the plugin through the ‚ÄúPlugins‚Äù menu
3. Go to **WooCommerce ‚Üí Settings ‚Üí Payments ‚Üí Bonzai**
4. Enter your **API Token** and **Product UUID**
5. Configure the webhook URL in your Bonzai dashboard

== Configuration ==

=== API Token ===
Your Bonzai API token from **bonzai.pro/business**.

=== Global Bonzai Product UUID ===
This UUID is used to generate checkout sessions for all WooCommerce products.

=== VAT Handling ===
You can control whether prices include VAT:

* Global setting for all products
* Per-product override (include / exclude / inherit)

=== Payment Mode (One-off or Subscription) ===
Each product can define how Bonzai should charge the customer:

* One-off
* Subscription (monthly)
* Subscription (yearly)
* Auto-detect (if WooCommerce Subscriptions is installed)

=== Redirect URL ===
Where the customer returns after completing Bonzai Checkout.

=== Currency ===
Choose between:
- WooCommerce store currency
- Forced EUR
- Forced USD

=== Minimum Amount ===
Minimum cart total to display the payment method.

=== Generate Webhook Token ===
Click **Generate token** to instantly create a secure token.

=== Webhook URL ===
This URL must be added to Bonzai Premium:

https://yourwebsite.com/wp-json/bonzai/v1/webhook?token=YOUR_TOKEN

Paste it into **bonzai.pro/business ‚Üí Webhooks**.

=== Debug Logs ===
Enable logging at:
**WooCommerce ‚Üí Status ‚Üí Logs ‚Üí bonzai-gateway**

== Webhook Events ==

The plugin fully supports Bonzai webhook events:

=== product_access_granted ===
* Marks WooCommerce order as **completed**
* Confirms access delivery

=== product_access_revoked ===
* If order was previously paid: marks as **refunded**
* If order was never paid: status remains unchanged
* Access is revoked on Bonzai‚Äôs side

== Payment Flow ==

1. Customer places order on WooCommerce
2. Order is created (pending payment)
3. Customer is redirected to Bonzai Checkout
4. Customer pays using card or crypto
5. Bonzai sends webhook confirmation
6. WooCommerce updates status automatically
7. Customer returns to thank-you page

== Dynamic Checkout Title ==

The plugin generates an optimized title sent to Bonzai:

* Single product ‚Üí product name
* Multiple products ‚Üí ‚ÄúProduct A (+X more items)‚Äù
* Fallback ‚Üí ‚ÄúWooCommerce Order #123‚Äù

== Retrieve-an-Order (Order Verification) ==

Bonzai‚Äôs ‚ÄúRetrieve an order‚Äù API is fully integrated.

=== Manual Sync (Admin Page) ===

Go to:
**WooCommerce ‚Üí Bonzai Order Sync**

Features:
* Search orders by customer email
* View all orders + Bonzai order_id
* Click **‚ÄúSync with Bonzai‚Äù** to:
  - Fetch order from Bonzai API
  - Update WooCommerce order status
  - Add detailed notes

If Bonzai cannot find the order:
A clear error message is displayed (‚Äúorder not found / expired / never completed‚Äù).

=== Automatic Sync (Cron) ===

You can enable background sync:

* Disabled
* Daily (at chosen hour)
* Weekly (day + hour)

During automatic sync:
- All orders with a Bonzai order_id are checked
- Access state is compared
- WooCommerce orders are updated accordingly
- Logs are written if debug mode is enabled

== Requirements ==

* WordPress 5.0+
* WooCommerce 5.0+
* PHP 7.4+
* Active Bonzai Premium Subscription
* Valid API Token
* Valid Product UUID

== Frequently Asked Questions ==

= Do I need a different Bonzai UUID per product? =
Not currently. This plugin uses one global UUID for all products.

= Are subscriptions supported? =
Yes ‚Äî monthly and yearly subscriptions, plus auto-detection of WooCommerce Subscription products.

= Do I need a webhook? =
Yes. Webhooks are required for automatic status updates and access delivery.

= Can I manually re-validate an order? =
Yes, using the built-in admin tool:
**WooCommerce ‚Üí Bonzai Order Sync**.

== Support ==

For assistance, contact the official Bonzai support team:

üì© support@bonzai.pro

== Changelog ==

= 1.5.0 =
* Added subscription support (monthly, yearly, auto-detect)
* Added per-product VAT handling
* Added per-product payment mode
* Added automatic cron sync (daily/weekly) for Retrieve-an-Order
* Added manual admin sync page
* Improved webhook token system + Generate Token button
* Webhook URL now updates dynamically
* Better error reporting from Bonzai API
* Prevents refunded status on unpaid orders
* Enhanced logs and debugging

= 1.3.1 =
* Added English admin UI
* Global Product UUID implementation
* Improved webhook validation
* Dynamic product-based checkout title
* Error handling improvements
* Updated debug system
